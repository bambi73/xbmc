diff --git a/diff.txt b/diff.txt
new file mode 100644
index 0000000..e69de29
diff --git a/project/VS2010Express/XBMC.vcxproj b/project/VS2010Express/XBMC.vcxproj
index c640130..30d91b0 100644
--- a/project/VS2010Express/XBMC.vcxproj
+++ b/project/VS2010Express/XBMC.vcxproj
@@ -1135,6 +1135,7 @@
     <ClInclude Include="..\..\xbmc\utils\uXstrings.h" />
     <ClInclude Include="..\..\xbmc\utils\Vector.h" />
     <ClInclude Include="..\..\xbmc\utils\XSLTUtils.h" />
+    <ClInclude Include="..\..\xbmc\video\BackgroundFilterProcessor.h" />
     <ClInclude Include="..\..\xbmc\video\FFmpegVideoDecoder.h" />
     <ClInclude Include="..\..\xbmc\interfaces\python\swig.h" />
     <ClInclude Include="..\..\xbmc\interfaces\python\XBPython.h" />
@@ -1286,6 +1287,7 @@
     <ClCompile Include="..\..\xbmc\utils\Utf8Utils.cpp" />
     <ClCompile Include="..\..\xbmc\utils\Vector.cpp" />
     <ClCompile Include="..\..\xbmc\utils\XSLTUtils.cpp" />
+    <ClCompile Include="..\..\xbmc\video\BackgroundFilterProcessor.cpp" />
     <ClCompile Include="..\..\xbmc\video\PlayerController.cpp" />
     <ClCompile Include="..\..\xbmc\video\VideoThumbLoader.cpp" />
     <ClCompile Include="..\..\xbmc\music\MusicThumbLoader.cpp" />
diff --git a/project/VS2010Express/XBMC.vcxproj.filters b/project/VS2010Express/XBMC.vcxproj.filters
index b536eb3..a4c997f 100644
--- a/project/VS2010Express/XBMC.vcxproj.filters
+++ b/project/VS2010Express/XBMC.vcxproj.filters
@@ -3104,6 +3104,9 @@
     <ClCompile Include="..\..\xbmc\cores\dvdplayer\DVDCodecs\Video\DVDVideoCodec.cpp">
       <Filter>cores\dvdplayer\DVDCodecs\Video</Filter>
     </ClCompile>
+    <ClCompile Include="..\..\xbmc\video\BackgroundFilterProcessor.cpp">
+      <Filter>video</Filter>
+    </ClCompile>
   </ItemGroup>
   <ItemGroup>
     <ClInclude Include="..\..\xbmc\win32\pch.h">
@@ -6094,6 +6097,9 @@
     <ClInclude Include="..\..\xbmc\win32\IMMNotificationClient.h">
       <Filter>win32</Filter>
     </ClInclude>
+    <ClInclude Include="..\..\xbmc\video\BackgroundFilterProcessor.h">
+      <Filter>video</Filter>
+    </ClInclude>
   </ItemGroup>
   <ItemGroup>
     <ResourceCompile Include="..\..\xbmc\win32\XBMC_PC.rc">
diff --git a/xbmc/FileItem.cpp b/xbmc/FileItem.cpp
index eb0e4a5..330f4d4 100644
--- a/xbmc/FileItem.cpp
+++ b/xbmc/FileItem.cpp
@@ -299,6 +299,7 @@ CFileItem::CFileItem(const CFileItem& item): CGUIListItem()
   m_pvrRecordingInfoTag = NULL;
   m_pvrTimerInfoTag = NULL;
   m_pictureInfoTag = NULL;
+  m_bIsDirty = false;
   *this = item;
 }
 
@@ -581,6 +582,7 @@ void CFileItem::Reset()
   m_pictureInfoTag=NULL;
   m_extrainfo.clear();
   m_specialSort = SortSpecialNone;
+  m_bIsDirty = false;
   ClearProperties();
   SetInvalid();
 }
@@ -1529,6 +1531,31 @@ void CFileItem::SetFromVideoInfoTag(const CVideoInfoTag &video)
   FillInMimeType(false);
 }
 
+void CFileItem::SetFromVideoInfoTagFast(const CVideoInfoTag &video, const CStdString& defaultIcon)
+{
+  if (!video.m_strTitle.empty())
+    SetLabel(video.m_strTitle);
+  if (video.m_strFileNameAndPath.empty())
+  {
+    m_strPath = video.m_strPath;
+    char endChar = m_strPath.c_str()[m_strPath.size() - 1];
+    if(endChar != '/' && endChar != '\\')
+      URIUtils::AddSlashAtEnd(m_strPath);
+    m_bIsFolder = true;
+  }
+  else
+  {
+    m_strPath = video.m_strFileNameAndPath;
+    m_bIsFolder = false;
+  }
+
+  *GetVideoInfoTag() = video;
+  if (video.m_iSeason == 0)
+    SetProperty("isspecial", "true");
+  SetIconImage(defaultIcon);
+  FillInMimeType(false);
+}
+
 void CFileItem::SetFromAlbum(const CAlbum &album)
 {
   if (!album.strAlbum.empty())
diff --git a/xbmc/FileItem.h b/xbmc/FileItem.h
index 286bd34..48ee4a8 100644
--- a/xbmc/FileItem.h
+++ b/xbmc/FileItem.h
@@ -412,6 +412,7 @@ public:
    \param video video details to use and set
    */
   void SetFromVideoInfoTag(const CVideoInfoTag &video);
+  void SetFromVideoInfoTagFast(const CVideoInfoTag &video, const CStdString& defaultIcon);
   /*! \brief Sets details using the information from the CAlbum object
    Sets the album in the music info tag and uses its information to set the
    label and album-specific properties.
@@ -425,6 +426,9 @@ public:
    */
   void SetFromSong(const CSong &song);
 
+  bool IsDirty() const { return m_bIsDirty; }
+  void SetDirty(bool dirty) { m_bIsDirty = dirty; }
+
   bool m_bIsShareOrDrive;    ///< is this a root share/drive
   int m_iDriveType;     ///< If \e m_bIsShareOrDrive is \e true, use to get the share type. Types see: CMediaSource::m_iDriveType
   CDateTime m_dateTime;             ///< file creation date & time
@@ -458,6 +462,8 @@ private:
   PVR::CPVRTimerInfoTag * m_pvrTimerInfoTag;
   CPictureInfoTag* m_pictureInfoTag;
   bool m_bIsAlbum;
+
+  bool m_bIsDirty;
 };
 
 /*!
diff --git a/xbmc/filesystem/Directory.cpp b/xbmc/filesystem/Directory.cpp
index de98f21..e7fb429 100644
--- a/xbmc/filesystem/Directory.cpp
+++ b/xbmc/filesystem/Directory.cpp
@@ -127,6 +127,8 @@ bool CDirectory::GetDirectory(const CStdString& strPath, CFileItemList &items, c
 
 bool CDirectory::GetDirectory(const CStdString& strPath, CFileItemList &items, const CHints &hints, bool allowThreads)
 {
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+
   try
   {
     CStdString realPath = URIUtils::SubstitutePath(strPath);
@@ -135,8 +137,10 @@ bool CDirectory::GetDirectory(const CStdString& strPath, CFileItemList &items, c
       return false;
 
     // check our cache for this path
-    if (g_directoryCache.GetDirectory(realPath, items, (hints.flags & DIR_FLAG_READ_CACHE) == DIR_FLAG_READ_CACHE))
+    if (!(hints.flags & DIR_FLAG_BYPASS_CACHE) &&
+        g_directoryCache.GetDirectory(realPath, items, (hints.flags & DIR_FLAG_READ_CACHE) == DIR_FLAG_READ_CACHE)) {
       items.SetPath(strPath);
+    }
     else
     {
       // need to clear the cache (in case the directory fetch fails)
@@ -233,6 +237,8 @@ bool CDirectory::GetDirectory(const CStdString& strPath, CFileItemList &items, c
       }
     }
 
+    CLog::Log(LOGDEBUG, "%s took %d ms ", __FUNCTION__, XbmcThreads::SystemClockMillis() - timeFull);
+
     return true;
   }
   XBMCCOMMONS_HANDLE_UNCHECKED
diff --git a/xbmc/filesystem/SmartPlaylistDirectory.cpp b/xbmc/filesystem/SmartPlaylistDirectory.cpp
index 77ad2df..4d3ab78 100644
--- a/xbmc/filesystem/SmartPlaylistDirectory.cpp
+++ b/xbmc/filesystem/SmartPlaylistDirectory.cpp
@@ -67,6 +67,8 @@ namespace XFILE
     bool success = false, success2 = false;
     std::vector<CStdString> virtualFolders;
 
+    unsigned int timeFull = XbmcThreads::SystemClockMillis();
+
     SortDescription sorting;
     sorting.limitEnd = playlist.GetLimit();
     sorting.sortBy = playlist.GetOrder();
@@ -148,7 +150,7 @@ namespace XFILE
           videoUrl.AddOption(option, xsp);
         else
           videoUrl.RemoveOption(option);
-        
+
         CDatabase::Filter dbfilter;
         success = db.GetItems(videoUrl.ToString(), items, dbfilter, sorting);
         db.Close();
@@ -309,6 +311,8 @@ namespace XFILE
       item->m_iprogramCount = i;  // hack for playlist order
     }
 
+    CLog::Log(LOGDEBUG, "%s took %d ms ", "CSmartPlaylistDirectory::GetDirectory", XbmcThreads::SystemClockMillis() - timeFull);
+
     if (playlist.GetType().Equals("mixed"))
       return success || success2;
     else if (playlist.GetType().Equals("musicvideos"))
diff --git a/xbmc/filesystem/VirtualDirectory.cpp b/xbmc/filesystem/VirtualDirectory.cpp
index 7146c6c..29346e8 100644
--- a/xbmc/filesystem/VirtualDirectory.cpp
+++ b/xbmc/filesystem/VirtualDirectory.cpp
@@ -75,6 +75,8 @@ bool CVirtualDirectory::GetDirectory(const CStdString& strPath, CFileItemList &i
 bool CVirtualDirectory::GetDirectory(const CStdString& strPath, CFileItemList &items, bool bUseFileDirectories)
 {
   int flags = m_flags;
+  if (!(flags & DIR_FLAG_READ_CACHE))
+    flags |= DIR_FLAG_BYPASS_CACHE;
   if (!bUseFileDirectories)
     flags |= DIR_FLAG_NO_FILE_DIRS;
   if (!strPath.empty() && strPath != "files://")
diff --git a/xbmc/utils/SortUtils.cpp b/xbmc/utils/SortUtils.cpp
index 655b1dd..095fbde 100644
--- a/xbmc/utils/SortUtils.cpp
+++ b/xbmc/utils/SortUtils.cpp
@@ -27,6 +27,7 @@
 #include "utils/StdString.h"
 #include "utils/StringUtils.h"
 #include "utils/Variant.h"
+#include "utils/log.h"
 
 using namespace std;
 
@@ -707,7 +708,11 @@ void SortUtils::Sort(const SortDescription &sortDescription, SortItems& items)
 
 bool SortUtils::SortFromDataset(const SortDescription &sortDescription, MediaType mediaType, const std::auto_ptr<dbiplus::Dataset> &dataset, DatabaseResults &results)
 {
-  FieldList fields;
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+  unsigned int timePart = XbmcThreads::SystemClockMillis();
+ 	CLog::Log(LOGDEBUG, "%s started", "SortUtils::SortFromDataset");
+
+ 	FieldList fields;
   if (!DatabaseUtils::GetSelectFields(SortUtils::GetFieldsForSorting(sortDescription.sortBy), mediaType, fields))
     fields.clear();
 
@@ -721,8 +726,14 @@ bool SortUtils::SortFromDataset(const SortDescription &sortDescription, MediaTyp
     sorting.limitEnd = -1;
   }
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "SortUtils::SortFromDataset loading from dataset", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
   Sort(sorting, results);
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "SortUtils::SortFromDataset sorting", XbmcThreads::SystemClockMillis() - timePart);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "SortUtils::SortFromDataset", XbmcThreads::SystemClockMillis() - timeFull);
+
   return true;
 }
 
diff --git a/xbmc/video/VideoDatabase.cpp b/xbmc/video/VideoDatabase.cpp
index aa810d9..938c8c5 100644
--- a/xbmc/video/VideoDatabase.cpp
+++ b/xbmc/video/VideoDatabase.cpp
@@ -2137,12 +2137,15 @@ int CVideoDatabase::SetDetailsForTvShow(const CStdString& strPath, const CVideoI
     }
 
     BeginTransaction();
+    bool bUpdateCache = false;
 
     if (idTvShow < 0)
       idTvShow = GetTvShowId(strPath);
 
-    if (idTvShow > -1)
+    if (idTvShow > -1) {
       DeleteDetailsForTvShow(strPath, idTvShow);
+      bUpdateCache = true;
+    }
     else
     {
       idTvShow = AddTvShow(strPath);
@@ -2193,6 +2196,11 @@ int CVideoDatabase::SetDetailsForTvShow(const CStdString& strPath, const CVideoI
     sql += PrepareSQL(" where idShow=%i", idTvShow);
     m_pDS->exec(sql.c_str());
 
+    if(bUpdateCache)
+      UpdateTvShowFileItemById(idTvShow);
+    else
+      sm_TvShowCache.DirtyAllTvShowCacheItems();
+
     CommitTransaction();
 
     return idTvShow;
@@ -2316,6 +2324,9 @@ int CVideoDatabase::SetDetailsForEpisode(const CStdString& strFilenameAndPath, c
     CStdString sql = "update episode set " + GetValueString(details, VIDEODB_ID_EPISODE_MIN, VIDEODB_ID_EPISODE_MAX, DbEpisodeOffsets);
     sql += PrepareSQL(" where idEpisode=%i", idEpisode);
     m_pDS->exec(sql.c_str());
+
+    UpdateTvShowFileItemById(idShow);
+
     CommitTransaction();
 
     return idEpisode;
@@ -2939,7 +2950,7 @@ void CVideoDatabase::DeleteTvShow(const CStdString& strPath, bool bKeepId /* = f
       CStdString strPath = m_pDS2->fv("path.strPath").get_asString();
       CStdString strFileName = m_pDS2->fv("files.strFilename").get_asString();
       ConstructPath(strFilenameAndPath, strPath, strFileName);
-      DeleteEpisode(strFilenameAndPath, m_pDS2->fv(0).get_asInt(), bKeepId);
+      DeleteEpisode(strFilenameAndPath, m_pDS2->fv(0).get_asInt(), bKeepId, bKeepId);
       m_pDS2->next();
     }
 
@@ -2961,6 +2972,7 @@ void CVideoDatabase::DeleteTvShow(const CStdString& strPath, bool bKeepId /* = f
       m_pDS->exec(strSQL.c_str());
 
       InvalidatePathHash(strPath);
+      sm_TvShowCache.ProcessAffectedTvShowFileItems(idTvShow, NULL, false, true);
    }
 
     //TODO: move this below CommitTransaction() once UPnP doesn't rely on this anymore
@@ -2988,7 +3000,8 @@ void CVideoDatabase::DeleteEpisode(int idEpisode, bool bKeepId /* = false */)
     DeleteEpisode(path, idEpisode, bKeepId);
 }
 
-void CVideoDatabase::DeleteEpisode(const CStdString& strFilenameAndPath, int idEpisode /* = -1 */, bool bKeepId /* = false */)
+void CVideoDatabase::DeleteEpisode(
+    const CStdString& strFilenameAndPath, int idEpisode /* = -1 */, bool bKeepId /* = false */, bool bUpdateCache /* = true */)
 {
   try
   {
@@ -3023,10 +3036,17 @@ void CVideoDatabase::DeleteEpisode(const CStdString& strFilenameAndPath, int idE
     // the ancilliary tables are still purged
     if (!bKeepId)
     {
+      int showId = -1;
+
       ClearBookMarksOfFile(strFilenameAndPath);
+      if(bUpdateCache)
+        showId = GetTvShowForEpisode(idEpisode);
 
       strSQL=PrepareSQL("delete from episode where idEpisode=%i", idEpisode);
       m_pDS->exec(strSQL.c_str());
+
+      if(bUpdateCache)
+        UpdateTvShowFileItemById(showId);
     }
 
   }
@@ -4513,6 +4533,9 @@ void CVideoDatabase::SetPlayCount(const CFileItem &item, int count, const CDateT
       }
       else
         ANNOUNCEMENT::CAnnouncementManager::Announce(ANNOUNCEMENT::VideoLibrary, "xbmc", "OnUpdate", CFileItemPtr(new CFileItem(item)));
+
+      if(item.GetVideoInfoTag()->m_type == "episode")
+        UpdateTvShowFileItemById(item.GetVideoInfoTag()->m_iIdShow);
     }
   }
   catch (...)
@@ -5976,6 +5999,8 @@ bool CVideoDatabase::GetTvShowsNav(const CStdString& strBaseDir, CFileItemList&
 
 bool CVideoDatabase::GetTvShowsByWhere(const CStdString& strBaseDir, const Filter &filter, CFileItemList& items, const SortDescription &sortDescription /* = SortDescription() */)
 {
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+
   try
   {
     movieTime = 0;
@@ -5988,13 +6013,15 @@ bool CVideoDatabase::GetTvShowsByWhere(const CStdString& strBaseDir, const Filte
     CStdString strSQL = "SELECT %s FROM tvshowview ";
     CVideoDbUrl videoUrl;
     CStdString strSQLExtra;
-    Filter extFilter = filter;
     SortDescription sorting = sortDescription;
+    Filter extFilter = filter;
+    if(sorting.sortBy == SortByNone || sorting.sortBy == SortByTitle || sorting.sortBy == SortBySortTitle)
+      extFilter.AppendOrder("c00");
     if (!BuildSQL(strBaseDir, strSQLExtra, extFilter, strSQLExtra, videoUrl, sorting))
       return false;
 
     // Apply the limiting directly here if there's no special sorting but limiting
-      if (extFilter.limit.empty() &&
+    if (extFilter.limit.empty() &&
         sorting.sortBy == SortByNone &&
         (sorting.limitStart > 0 || sorting.limitEnd > 0))
     {
@@ -6004,7 +6031,20 @@ bool CVideoDatabase::GetTvShowsByWhere(const CStdString& strBaseDir, const Filte
 
     strSQL = PrepareSQL(strSQL, !extFilter.fields.empty() ? extFilter.fields.c_str() : "*") + strSQLExtra;
 
+    CTvShowCacheItemPtr cacheTvShowCacheItemPtr;
+
+    MAPI_STRING2TVSHOWCACHEITEMPTR sqlQueryIter = sm_TvShowCache.m_sqlQuery2TvShowCacheItemPtr.find(strSQL);
+    if(sqlQueryIter != sm_TvShowCache.m_sqlQuery2TvShowCacheItemPtr.end())
+      cacheTvShowCacheItemPtr = sqlQueryIter->second;
+
+    if(cacheTvShowCacheItemPtr && !cacheTvShowCacheItemPtr->IsDirty()) {
+      items.Copy(*cacheTvShowCacheItemPtr->m_fileItemListPtr);
+      CLog::Log(LOGDEBUG, "%s took %d ms ", "CVideoDatabase::GetTvShowsByWhere", XbmcThreads::SystemClockMillis() - timeFull);
+      return true;
+    }
+
     int iRowsFound = RunQuery(strSQL);
+
     if (iRowsFound <= 0)
       return iRowsFound == 0;
 
@@ -6015,46 +6055,131 @@ bool CVideoDatabase::GetTvShowsByWhere(const CStdString& strBaseDir, const Filte
     
     DatabaseResults results;
     results.reserve(iRowsFound);
+
     if (!SortUtils::SortFromDataset(sorting, MediaTypeTvShow, m_pDS, results))
       return false;
 
+    unsigned int timeFill = 0;
+    unsigned int timeSumGetVideoTag = 0;
+    unsigned int timeSumFillFileItem = 0;
+    unsigned int timePart = XbmcThreads::SystemClockMillis();
+
+    CURL baseURL(strBaseDir);
+    CStdString baseURLMain;
+    CStdString baseURLOptions;
+
+    baseURLMain = baseURL.GetWithoutFilename();
+    baseURLMain += baseURL.GetFileName();
+
+    if(!baseURL.GetOptions().empty())
+      baseURLOptions += baseURL.GetOptions();
+    if(!baseURL.GetProtocolOptions().empty())
+      baseURLOptions += ("|" + baseURL.GetProtocolOptions());
+
+    int baseURLReserve = baseURLMain.length() + (!baseURLOptions.empty() ? baseURLOptions.length() : 0) + 8;
+
+    bool cacheInsertMode;
+    int takenFromCache = 0;
+
+    if(!cacheTvShowCacheItemPtr) {
+      cacheTvShowCacheItemPtr = CTvShowCacheItemPtr(new CTvShowCacheItem);
+      cacheTvShowCacheItemPtr->m_fileItemListPtr = CFileItemListPtr(new CFileItemList);
+      cacheTvShowCacheItemPtr->m_fileItemListPtr->Copy(items, false);
+      sm_TvShowCache.m_sqlQuery2TvShowCacheItemPtr[strSQL] = cacheTvShowCacheItemPtr;
+      cacheInsertMode = true;
+    }
+    else {
+      cacheTvShowCacheItemPtr->m_fileItemListPtr->ClearItems();
+      cacheInsertMode = false;
+    }
+
+    cacheTvShowCacheItemPtr->SetDirty(false);
+
     // get data from returned rows
     items.Reserve(results.size());
+    cacheTvShowCacheItemPtr->m_fileItemListPtr->Reserve(results.size());
+
     const query_data &data = m_pDS->get_result_set().records;
     for (DatabaseResults::const_iterator it = results.begin(); it != results.end(); it++)
     {
+      timeFill = XbmcThreads::SystemClockMillis();
+
       unsigned int targetRow = (unsigned int)it->at(FieldRow).asInteger();
       const dbiplus::sql_record* const record = data.at(targetRow);
-      
+      int idTvShow = record->at(0).get_asInt();
+
+      if(!cacheInsertMode) {
+        MAPI_INT2FILEITEMPTR tvShowId2FileItemPtrIter = cacheTvShowCacheItemPtr->m_tvShowId2FileItemPtr.find(idTvShow);
+        if(tvShowId2FileItemPtrIter != cacheTvShowCacheItemPtr->m_tvShowId2FileItemPtr.end()) {
+          CFileItemPtr cacheFileItemPtr = tvShowId2FileItemPtrIter->second;
+          if(!cacheFileItemPtr->IsDirty()) {
+            CFileItemPtr pItem(new CFileItem(*cacheFileItemPtr.get()));
+            cacheTvShowCacheItemPtr->m_fileItemListPtr->Add(cacheFileItemPtr);
+            items.Add(pItem);
+            takenFromCache++;
+
+            continue;
+          }
+        }
+      }
+
       CFileItemPtr pItem(new CFileItem());
       CVideoInfoTag movie = GetDetailsForTvShow(record, false, pItem.get());
+
+      timeSumGetVideoTag += (XbmcThreads::SystemClockMillis() - timeFill);
+      timeFill = XbmcThreads::SystemClockMillis();
+
       if ((CProfilesManager::Get().GetMasterProfile().getLockMode() == LOCK_MODE_EVERYONE ||
            g_passwordManager.bMasterUser                                     ||
            g_passwordManager.IsDatabasePathUnlocked(movie.m_strPath, *CMediaSourceSettings::Get().GetSources("video"))) &&
           (!g_advancedSettings.m_bVideoLibraryHideEmptySeries || movie.m_iEpisode > 0))
       {
-        pItem->SetFromVideoInfoTag(movie);
+        pItem->SetFromVideoInfoTagFast(movie, "DefaultFolder.png");
 
-        CVideoDbUrl itemUrl = videoUrl;
-        CStdString path = StringUtils::Format("%ld/", record->at(0).get_asInt());
-        itemUrl.AppendPath(path);
-        pItem->SetPath(itemUrl.ToString());
+        CStdString path;
+        path.reserve(baseURLReserve);
+        path = baseURLMain;
+        path += StringUtils::Format("%ld/",record->at(0).get_asInt());
+        if(!baseURLOptions.empty())
+          path += baseURLOptions;
+
+        pItem->SetPath(path);
 
         pItem->SetOverlayImage(CGUIListItem::ICON_OVERLAY_UNWATCHED, (pItem->GetVideoInfoTag()->m_playCount > 0) && (pItem->GetVideoInfoTag()->m_iEpisode > 0));
         items.Add(pItem);
+
+        CFileItemPtr cacheItemPtr(new CFileItem(*pItem));
+        cacheTvShowCacheItemPtr->m_fileItemListPtr->Add(cacheItemPtr);
+        cacheTvShowCacheItemPtr->m_tvShowId2FileItemPtr[idTvShow] = cacheItemPtr;
+        sm_TvShowCache.m_tvShowId2TvShowCacheItemPtrSet[idTvShow].insert(cacheTvShowCacheItemPtr);
       }
+
+      timeSumFillFileItem += (XbmcThreads::SystemClockMillis() - timeFill);
     }
 
-    Stack(items, VIDEODB_CONTENT_TVSHOWS, !filter.order.empty() || sorting.sortBy != SortByNone);
+    CLog::Log(LOGDEBUG, "%s took %d ms ", "CVideoDatabase::GetTvShowsByWhere processing data - GetVideoTag", timeSumGetVideoTag);
+    CLog::Log(LOGDEBUG, "%s took %d ms ", "CVideoDatabase::GetTvShowsByWhere processing data - FillFileItem", timeSumFillFileItem);
+    CLog::Log(LOGDEBUG, "%s took %d ms ", "CVideoDatabase::GetTvShowsByWhere processing data", XbmcThreads::SystemClockMillis() - timePart);
+
+    CLog::Log(LOGDEBUG, "%s %d FileItems loaded (%d from cache)", __FUNCTION__, items.Size(), takenFromCache);
+    timePart = XbmcThreads::SystemClockMillis();
+
+    // Stack(items, VIDEODB_CONTENT_TVSHOWS, !filter.order.empty() || sorting.sortBy != SortByNone);
 
     // cleanup
     m_pDS->close();
+
+    CLog::Log(LOGDEBUG, "%s took %d ms ", "CVideoDatabase::GetTvShowsByWhere", XbmcThreads::SystemClockMillis() - timeFull);
+
     return true;
   }
   catch (...)
   {
     CLog::Log(LOGERROR, "%s failed", __FUNCTION__);
   }
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CVideoDatabase::GetTvShowsByWhere", XbmcThreads::SystemClockMillis() - timeFull);
+
   return false;
 }
 
@@ -7829,6 +7954,9 @@ void CVideoDatabase::CleanDatabase(CGUIDialogProgressBarHandle* handle, const se
     std::vector<int> episodeIDs;
     std::vector<int> musicVideoIDs;
 
+    std::set<int> cacheUpdateTvShowIds;
+    std::set<int> cacheDeleteTvShowIds;
+
     if (!filesToTestForDelete.empty())
     {
       StringUtils::TrimRight(filesToTestForDelete, ",");
@@ -7848,6 +7976,15 @@ void CVideoDatabase::CleanDatabase(CGUIDialogProgressBarHandle* handle, const se
     {
       filesToDelete = "(" + StringUtils::TrimRight(filesToDelete, ",") + ")";
 
+      CLog::Log(LOGDEBUG, "%s: Loading tvshows with cleaned files", __FUNCTION__);
+      sql = "SELECT DISTINCT episode.idShow FROM episode WHERE idFile IN " + filesToDelete;
+      m_pDS->query(sql.c_str());
+      while (!m_pDS->eof()) {
+        cacheUpdateTvShowIds.insert(m_pDS->fv(0).get_asInt());
+        m_pDS->next();
+      }
+      m_pDS->close();
+
       CLog::Log(LOGDEBUG, "%s: Cleaning files table", __FUNCTION__);
       sql = "DELETE FROM files WHERE idFile IN " + filesToDelete;
       m_pDS->exec(sql.c_str());
@@ -7912,6 +8049,15 @@ void CVideoDatabase::CleanDatabase(CGUIDialogProgressBarHandle* handle, const se
         episodesToDelete += StringUtils::Format("%i,", *it);
       episodesToDelete = "(" + StringUtils::TrimRight(episodesToDelete, ",") + ")";
 
+      CLog::Log(LOGDEBUG, "%s: Loading tvshows with cleaned episodes", __FUNCTION__);
+      sql = "SELECT DISTINCT episode.idShow FROM episode WHERE idEpisode IN " + episodesToDelete;
+      m_pDS->query(sql.c_str());
+      while (!m_pDS->eof()) {
+        cacheUpdateTvShowIds.insert(m_pDS->fv(0).get_asInt());
+        m_pDS->next();
+      }
+      m_pDS->close();
+
       CLog::Log(LOGDEBUG, "%s: Cleaning episode table", __FUNCTION__);
       sql = "DELETE FROM episode WHERE idEpisode IN " + episodesToDelete;
       m_pDS->exec(sql.c_str());
@@ -7957,6 +8103,14 @@ void CVideoDatabase::CleanDatabase(CGUIDialogProgressBarHandle* handle, const se
     }
 
     CLog::Log(LOGDEBUG, "%s: Cleaning tvshow table", __FUNCTION__);
+    sql = "SELECT tvshow.idShow FROM tvshow WHERE NOT EXISTS (SELECT 1 FROM tvshowlinkpath WHERE tvshowlinkpath.idShow = tvshow.idShow)";
+    m_pDS->query(sql.c_str());
+    while (!m_pDS->eof())
+    {
+      cacheDeleteTvShowIds.insert(m_pDS->fv(0).get_asInt());
+      m_pDS->next();
+    }
+    m_pDS->close();
     sql = "DELETE FROM tvshow WHERE NOT EXISTS (SELECT 1 FROM tvshowlinkpath WHERE tvshowlinkpath.idShow = tvshow.idShow)";
     m_pDS->exec(sql.c_str());
 
@@ -7969,6 +8123,7 @@ void CVideoDatabase::CleanDatabase(CGUIDialogProgressBarHandle* handle, const se
     m_pDS->query(sql.c_str());
     while (!m_pDS->eof())
     {
+      cacheDeleteTvShowIds.insert(m_pDS->fv(0).get_asInt());
       tvshowIDs.push_back(m_pDS->fv(0).get_asInt());
       tvshowsToDelete += m_pDS->fv(0).get_asString() + ",";
       m_pDS->next();
@@ -8085,6 +8240,17 @@ void CVideoDatabase::CleanDatabase(CGUIDialogProgressBarHandle* handle, const se
     sql = "DELETE FROM sets WHERE NOT EXISTS (SELECT 1 FROM movie WHERE movie.idSet = sets.idSet)";
     m_pDS->exec(sql.c_str());
 
+    CLog::Log(LOGDEBUG, "%s: Updating cache items", __FUNCTION__);
+    for(std::set<int>::const_iterator it = cacheUpdateTvShowIds.begin(); it != cacheUpdateTvShowIds.end(); ++it) {
+      if(cacheDeleteTvShowIds.find(*it) == cacheDeleteTvShowIds.end())
+        UpdateTvShowFileItemById(*it);
+    }
+
+    CLog::Log(LOGDEBUG, "%s: Deleting cache items", __FUNCTION__);
+    for(std::set<int>::const_iterator it = cacheDeleteTvShowIds.begin(); it != cacheDeleteTvShowIds.end(); ++it) {
+      sm_TvShowCache.ProcessAffectedTvShowFileItems(*it, NULL, false, true);
+    }
+
     CommitTransaction();
 
     if (handle)
@@ -9179,6 +9345,8 @@ void CVideoDatabase::AnnounceRemove(std::string content, int id)
 
 void CVideoDatabase::AnnounceUpdate(std::string content, int id)
 {
+  CLog::Log(LOGDEBUG, "CVideoDatabase::AnnounceUpdate(%s, %d)", content, id);
+
   CVariant data;
   data["type"] = content;
   data["id"] = id;
@@ -9682,3 +9850,156 @@ bool CVideoDatabase::GetFilter(CDbUrl &videoUrl, Filter &filter, SortDescription
 
   return true;
 }
+
+//********************************************************************************************************************************
+// Tady je Bambiho
+
+void CVideoDatabase::UpdateTvShowFileItemById(int showId) {
+  try {
+    if(showId < 0) return;
+
+    unsigned int time = XbmcThreads::SystemClockMillis();
+    int fileItemCount = 0;
+
+    VEC_FILEITEMPTR affectedFileItems;
+    sm_TvShowCache.ProcessAffectedTvShowFileItems(showId, &affectedFileItems, false, false);
+
+    if(!affectedFileItems.empty()) {
+      if(NULL == m_pDB.get()) return;
+      if(NULL == m_pDS2.get()) return;
+
+      CStdString sql = PrepareSQL(
+          "SELECT strPath, dateAdded, lastPlayed, totalCount, watchedcount, totalSeasons FROM tvshowview WHERE idShow=%i", showId);
+
+      if(!m_pDS2->query(sql.c_str()))
+        return;
+
+      if(m_pDS2->num_rows() > 0) {
+        const dbiplus::sql_record* const record = m_pDS2->get_sql_record();
+
+        if(record != NULL) {
+          CStdString strPath = record->at(0).get_asString();
+          CStdString dateAdded = record->at(1).get_asString();
+          CStdString lastPlayed = record->at(2).get_asString();
+          int totalCount = record->at(3).get_asInt();
+          int watchedCount = record->at(4).get_asInt();
+          int totalSeasons = record->at(5).get_asInt();
+
+          for(VECI_FILEITEMPTR fileItemIter = affectedFileItems.begin(); fileItemIter != affectedFileItems.end(); fileItemIter++) {
+            CFileItemPtr fileItemPtr = *fileItemIter;
+
+            if(fileItemPtr->HasVideoInfoTag()) {
+              fileItemPtr->GetVideoInfoTag()->m_strPath = strPath;
+              fileItemPtr->GetVideoInfoTag()->m_dateAdded.SetFromDBDateTime(dateAdded);
+              fileItemPtr->GetVideoInfoTag()->m_lastPlayed.SetFromDBDateTime(lastPlayed);
+              fileItemPtr->GetVideoInfoTag()->m_iEpisode = totalCount;
+              fileItemPtr->GetVideoInfoTag()->m_playCount = watchedCount;
+              fileItemPtr->GetVideoInfoTag()->m_strShowPath = fileItemPtr->GetVideoInfoTag()->m_strPath;
+
+              fileItemPtr->SetProperty("totalseasons", totalSeasons);
+              fileItemPtr->SetProperty("totalepisodes", fileItemPtr->GetVideoInfoTag()->m_iEpisode);
+              fileItemPtr->SetProperty("numepisodes", fileItemPtr->GetVideoInfoTag()->m_iEpisode);
+              fileItemPtr->SetProperty("watchedepisodes", fileItemPtr->GetVideoInfoTag()->m_playCount);
+              fileItemPtr->SetProperty("unwatchedepisodes", fileItemPtr->GetVideoInfoTag()->m_iEpisode - fileItemPtr->GetVideoInfoTag()->m_playCount);
+
+              fileItemPtr->GetVideoInfoTag()->m_playCount =
+                  (fileItemPtr->GetVideoInfoTag()->m_iEpisode <= fileItemPtr->GetVideoInfoTag()->m_playCount) ? 1 : 0;
+
+              fileItemPtr->SetOverlayImage(
+                  CGUIListItem::ICON_OVERLAY_UNWATCHED,
+                  (fileItemPtr->GetVideoInfoTag()->m_playCount > 0) && (fileItemPtr->GetVideoInfoTag()->m_iEpisode > 0));
+
+              fileItemCount++;
+            }
+            else {
+              CLog::Log(LOGERROR, "FileItem %s has no VideoInfoTag", fileItemPtr->GetPath());
+            }
+          }
+        }
+      }
+
+      m_pDS2->close();
+    }
+
+    CLog::Log(LOGDEBUG, "%s took %d ms and updated %d FileItem(s)", __FUNCTION__, XbmcThreads::SystemClockMillis() - time, fileItemCount);
+  }
+  catch(...) {
+    CLog::Log(LOGERROR, "%s (%d) failed", __FUNCTION__, showId);
+  }
+}
+
+//********************************************************************************************************************************
+
+CTvShowCache CVideoDatabase::sm_TvShowCache;
+
+//********************************************************************************************************************************
+
+CTvShowCacheItem::CTvShowCacheItem(void) {
+  m_bIsDirty = false;
+}
+
+CTvShowCacheItem::~CTvShowCacheItem(void) {
+  m_fileItemListPtr->Clear();
+  m_tvShowId2FileItemPtr.clear();
+}
+
+//********************************************************************************************************************************
+
+CTvShowCache::CTvShowCache(void) {}
+
+CTvShowCache::~CTvShowCache(void) {
+  m_tvShowId2TvShowCacheItemPtrSet.clear();
+  m_sqlQuery2TvShowCacheItemPtr.clear();
+}
+
+void CTvShowCache::DirtyAllTvShowCacheItems() {
+  CLog::Log(LOGDEBUG, "%s marking all caced file lists dirty", __FUNCTION__);
+
+  for(MAPI_STRING2TVSHOWCACHEITEMPTR tvShowCacheItemPtrIter = m_sqlQuery2TvShowCacheItemPtr.begin();
+      tvShowCacheItemPtrIter != m_sqlQuery2TvShowCacheItemPtr.end(); tvShowCacheItemPtrIter++) {
+    tvShowCacheItemPtrIter->second->SetDirty(true);
+  }
+}
+
+void CTvShowCache::DirtyTvShowFileItemById(int showId) {
+  ProcessAffectedTvShowFileItems(showId, NULL, true, false);
+}
+
+void CTvShowCache::ProcessAffectedTvShowFileItems(int showId, VEC_FILEITEMPTR *affectedFileItems, bool dirty, bool remove) {
+  unsigned int time = XbmcThreads::SystemClockMillis();
+  MAPI_INT2TVSHOWCACHEITEMPTRSET tvShowId2TvShowCacheItemPtrSetIter = m_tvShowId2TvShowCacheItemPtrSet.find(showId);
+
+  if(tvShowId2TvShowCacheItemPtrSetIter != m_tvShowId2TvShowCacheItemPtrSet.end()) {
+    SET_TVSHOWCACHEITEMPTR tvShowCacheItemPtrSet = tvShowId2TvShowCacheItemPtrSetIter->second;
+
+    for(SETI_TVSHOWCACHEITEMPTR tvShowCacheSetIter = tvShowCacheItemPtrSet.begin();
+        tvShowCacheSetIter != tvShowCacheItemPtrSet.end(); tvShowCacheSetIter++) {
+      CTvShowCacheItemPtr tvShowCacheItemPtr(*tvShowCacheSetIter);
+      if(dirty)
+        tvShowCacheItemPtr->SetDirty(true);
+
+      MAPI_INT2FILEITEMPTR tvShowId2FileItemPtrIter = tvShowCacheItemPtr->m_tvShowId2FileItemPtr.find(showId);
+
+      if(tvShowId2FileItemPtrIter != tvShowCacheItemPtr->m_tvShowId2FileItemPtr.end()) {
+        CFileItemPtr cacheFileItemPtr = tvShowId2FileItemPtrIter->second;
+
+        CLog::Log(LOGDEBUG, "%s on %s", __FUNCTION__, cacheFileItemPtr->GetPath());
+
+        if(affectedFileItems)
+          affectedFileItems->push_back(cacheFileItemPtr);
+        if(dirty)
+          cacheFileItemPtr->SetDirty(true);
+        if(remove) {
+          tvShowCacheItemPtr->m_fileItemListPtr->Remove(cacheFileItemPtr.get());
+          tvShowCacheItemPtr->m_tvShowId2FileItemPtr.erase(showId);
+          // Decrese 'total' property? Looks like it isn't necessary
+        }
+      }
+    }
+
+    if(remove)
+      m_tvShowId2TvShowCacheItemPtrSet.erase(showId);
+  }
+
+  CLog::Log(LOGDEBUG, "%s took %d ms for showId %d", __FUNCTION__, XbmcThreads::SystemClockMillis() - time, showId);
+}
diff --git a/xbmc/video/VideoDatabase.h b/xbmc/video/VideoDatabase.h
index 9f84b23..ae17f4c 100644
--- a/xbmc/video/VideoDatabase.h
+++ b/xbmc/video/VideoDatabase.h
@@ -24,6 +24,7 @@
 #include "Bookmark.h"
 #include "utils/SortUtils.h"
 #include "video/VideoDbUrl.h"
+#include "FileItem.h"
 
 #include <memory>
 #include <set>
@@ -331,6 +332,67 @@ const struct SDbTableOffsets DbMusicVideoOffsets[] =
 #define COMPARE_PERCENTAGE     0.90f // 90%
 #define COMPARE_PERCENTAGE_MIN 0.50f // 50%
 
+
+/* Tady je Bambiho */
+
+typedef boost::shared_ptr< CFileItemList > CFileItemListPtr;
+
+typedef std::map< int, CFileItemPtr > MAP_INT2FILEITEMPTR;
+typedef std::map< int, CFileItemPtr >::iterator MAPI_INT2FILEITEMPTR;
+typedef std::pair< int, CFileItemPtr > MAPP_INT2FILEITEMPTR;
+
+class CTvShowCacheItem {
+public:
+	CTvShowCacheItem();
+  virtual ~CTvShowCacheItem();
+
+  bool IsDirty() const { return m_bIsDirty; }
+  void SetDirty(bool isDirty) { m_bIsDirty = isDirty; }
+
+  CFileItemListPtr m_fileItemListPtr;
+  MAP_INT2FILEITEMPTR m_tvShowId2FileItemPtr;
+
+private:
+  bool m_bIsDirty;
+
+};
+
+typedef boost::shared_ptr< CTvShowCacheItem > CTvShowCacheItemPtr;
+
+typedef std::map< CStdString, CTvShowCacheItemPtr > MAP_STRING2TVSHOWCACHEITEMPTR;
+typedef std::map< CStdString, CTvShowCacheItemPtr >::iterator MAPI_STRING2TVSHOWCACHEITEMPTR;
+typedef std::pair< CStdString, CTvShowCacheItemPtr > MAPP_STRING2TVSHOWCACHEITEMPTR;
+
+typedef std::set< CTvShowCacheItemPtr > SET_TVSHOWCACHEITEMPTR;
+typedef std::set< CTvShowCacheItemPtr >::iterator SETI_TVSHOWCACHEITEMPTR;
+
+typedef std::vector< CFileItemPtr > VEC_FILEITEMPTR;
+typedef std::vector< CFileItemPtr >::iterator VECI_FILEITEMPTR;
+
+typedef std::map< int, SET_TVSHOWCACHEITEMPTR > MAP_INT2TVSHOWCACHEITEMPTRSET;
+typedef std::map< int, SET_TVSHOWCACHEITEMPTR >::iterator MAPI_INT2TVSHOWCACHEITEMPTRSET;
+typedef std::pair< int, SET_TVSHOWCACHEITEMPTR > MAPP_INT2TVSHOWCACHEITEMPTRSET;
+
+class CTvShowCache {
+public:
+	CTvShowCache();
+  virtual ~CTvShowCache();
+
+  void ProcessAffectedTvShowFileItems(int showId, VEC_FILEITEMPTR *affectedFileItems, bool dirty, bool remove);
+  void DirtyTvShowFileItemById(int showId);
+
+  void DirtyAllTvShowCacheItems();
+
+  MAP_STRING2TVSHOWCACHEITEMPTR m_sqlQuery2TvShowCacheItemPtr;
+  MAP_INT2TVSHOWCACHEITEMPTRSET m_tvShowId2TvShowCacheItemPtrSet;
+
+};
+
+
+
+
+
+
 class CVideoDatabase : public CDatabase
 {
 public:
@@ -464,7 +526,7 @@ public:
   void DeleteTvShow(int idTvShow, bool bKeepId = false);
   void DeleteTvShow(const CStdString& strPath, bool bKeepId = false, int idTvShow = -1);
   void DeleteEpisode(int idEpisode, bool bKeepId = false);
-  void DeleteEpisode(const CStdString& strFilenameAndPath, int idEpisode = -1, bool bKeepId = false);
+  void DeleteEpisode(const CStdString& strFilenameAndPath, int idEpisode = -1, bool bKeepId = false, bool bUpdateCache = true);
   void DeleteMusicVideo(int idMusicVideo, bool bKeepId = false);
   void DeleteMusicVideo(const CStdString& strFilenameAndPath, bool bKeepId = false, int idMVideo = -1);
   void DeleteDetailsForTvShow(const CStdString& strPath, int idTvShow = -1);
@@ -831,4 +893,9 @@ private:
 
   void AnnounceRemove(std::string content, int id);
   void AnnounceUpdate(std::string content, int id);
+
+  void UpdateTvShowFileItemById(int showId);
+
+  static CTvShowCache sm_TvShowCache;
+
 };
diff --git a/xbmc/video/windows/GUIWindowVideoNav.cpp b/xbmc/video/windows/GUIWindowVideoNav.cpp
index 60f3ad35..10045c7 100644
--- a/xbmc/video/windows/GUIWindowVideoNav.cpp
+++ b/xbmc/video/windows/GUIWindowVideoNav.cpp
@@ -58,6 +58,7 @@
 #include "video/VideoInfoScanner.h"
 #include "video/dialogs/GUIDialogVideoInfo.h"
 #include "pvr/recordings/PVRRecording.h"
+#include "video/BackgroundFilterProcessor.h"
 
 using namespace XFILE;
 using namespace VIDEODATABASEDIRECTORY;
@@ -116,6 +117,8 @@ bool CGUIWindowVideoNav::OnMessage(CGUIMessage& message)
   case GUI_MSG_WINDOW_DEINIT:
     if (m_thumbLoader.IsLoading())
       m_thumbLoader.StopThread();
+    if(m_backgroundFilterProcessor.IsFiltering())
+      m_backgroundFilterProcessor.StopFiltering();
     break;
   case GUI_MSG_WINDOW_INIT:
     {
@@ -269,6 +272,9 @@ CStdString CGUIWindowVideoNav::GetQuickpathName(const CStdString& strPath) const
 
 bool CGUIWindowVideoNav::GetDirectory(const CStdString &strDirectory, CFileItemList &items)
 {
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+  CLog::Log(LOGDEBUG, "%s started", __FUNCTION__);
+
   if (m_thumbLoader.IsLoading())
     m_thumbLoader.StopThread();
 
@@ -428,6 +434,9 @@ bool CGUIWindowVideoNav::GetDirectory(const CStdString &strDirectory, CFileItemL
       items.Add(newTag);
     }
   }
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", __FUNCTION__, XbmcThreads::SystemClockMillis() - timeFull);
+
   return bResult;
 }
 
@@ -584,9 +593,22 @@ void CGUIWindowVideoNav::UpdateButtons()
 
 bool CGUIWindowVideoNav::GetFilteredItems(const CStdString &filter, CFileItemList &items)
 {
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+  unsigned int timePart = XbmcThreads::SystemClockMillis();
+  CLog::Log(LOGDEBUG, "%s started", __FUNCTION__);
+  CLog::Log(LOGDEBUG, "%s items size before: %d", __FUNCTION__, items.Size());
+
   bool listchanged = CGUIMediaWindow::GetFilteredItems(filter, items);
+
+  CLog::Log(LOGDEBUG, "%s items size after: %d", __FUNCTION__, items.Size());
+  CLog::Log(LOGDEBUG, "%s:%s took %d ms", __FUNCTION__, "GetFilteredItems", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
   listchanged |= ApplyWatchedFilter(items);
 
+  CLog::Log(LOGDEBUG, "%s:%s took %d ms", __FUNCTION__, "ApplyWatchedFilter", XbmcThreads::SystemClockMillis() - timePart);
+  CLog::Log(LOGDEBUG, "%s took %d ms", __FUNCTION__, XbmcThreads::SystemClockMillis() - timeFull);
+
   return listchanged;
 }
 
@@ -1211,3 +1233,18 @@ bool CGUIWindowVideoNav::ApplyWatchedFilter(CFileItemList &items)
 
   return listchanged;
 }
+
+void CGUIWindowVideoNav::GetDirectoryHistoryString(const CFileItem* pItem, CStdString& strHistoryString) {
+  if (pItem->m_bIsShareOrDrive || (pItem->m_lEndOffset>pItem->m_lStartOffset && pItem->m_lStartOffset != -1) || !pItem->HasVideoInfoTag()) {
+    CGUIMediaWindow::GetDirectoryHistoryString(pItem, strHistoryString);
+  }
+  else {
+    strHistoryString = StringUtils::Format("%d",pItem->GetVideoInfoTag()->m_iDbId);
+  }
+}
+
+void CGUIWindowVideoNav::OnFilterItems(const CStdString &filter) {
+  CGUIMediaWindow::OnFilterItems(filter);
+}
+
+
diff --git a/xbmc/video/windows/GUIWindowVideoNav.h b/xbmc/video/windows/GUIWindowVideoNav.h
index 1854da3..05c604c 100644
--- a/xbmc/video/windows/GUIWindowVideoNav.h
+++ b/xbmc/video/windows/GUIWindowVideoNav.h
@@ -21,6 +21,7 @@
  */
 
 #include "GUIWindowVideoBase.h"
+#include "video/BackgroundFilterProcessor.h"
 
 class CFileItemList;
 
@@ -64,9 +65,14 @@ protected:
   virtual void GetContextButtons(int itemNumber, CContextButtons &buttons);
   virtual bool OnContextButton(int itemNumber, CONTEXT_BUTTON button);
   virtual bool OnClick(int iItem);
+  virtual void OnFilterItems(const CStdString &filter);
   virtual CStdString GetStartFolder(const CStdString &dir);
 
   virtual CStdString GetQuickpathName(const CStdString& strPath) const;
 
+  virtual void GetDirectoryHistoryString(const CFileItem* pItem, CStdString& strHistoryString);
+
   VECSOURCES m_shares;
+
+  CBackgroundFilterProcessor m_backgroundFilterProcessor;
 };
diff --git a/xbmc/windows/GUIMediaWindow.cpp b/xbmc/windows/GUIMediaWindow.cpp
index 3404f99..b821326 100644
--- a/xbmc/windows/GUIMediaWindow.cpp
+++ b/xbmc/windows/GUIMediaWindow.cpp
@@ -101,6 +101,8 @@ CGUIMediaWindow::CGUIMediaWindow(int id, const char *xmlFile)
 
 CGUIMediaWindow::~CGUIMediaWindow()
 {
+  CLog::Log(LOGDEBUG, "CGUIMediaWindow destroyed");
+
   delete m_vecItems;
   delete m_unfilteredItems;
 }
@@ -144,9 +146,13 @@ void CGUIMediaWindow::LoadAdditionalTags(TiXmlElement *root)
 
 void CGUIMediaWindow::OnWindowLoaded()
 {
+  CLog::Log(LOGDEBUG, "%s started", "CGUIMediaWindow::OnWindowLoaded");
+
   SendMessage(GUI_MSG_SET_TYPE, CONTROL_BTN_FILTER, CGUIEditControl::INPUT_TYPE_FILTER);
   CGUIWindow::OnWindowLoaded();
   SetupShares();
+
+  CLog::Log(LOGDEBUG, "%s finished", "CGUIMediaWindow::OnWindowLoaded");
 }
 
 void CGUIMediaWindow::OnWindowUnload()
@@ -570,7 +576,9 @@ void CGUIMediaWindow::ClearFileItems()
 // \brief Sorts Fileitems based on the sort method and sort oder provided by guiViewState
 void CGUIMediaWindow::SortItems(CFileItemList &items)
 {
-  auto_ptr<CGUIViewState> guiState(CGUIViewState::GetViewState(GetID(), items));
+	CLog::Log(LOGDEBUG, "%s started", "CGUIMediaWindow::SortItems");
+
+	auto_ptr<CGUIViewState> guiState(CGUIViewState::GetViewState(GetID(), items));
 
   if (guiState.get())
   {
@@ -599,6 +607,8 @@ void CGUIMediaWindow::SortItems(CFileItemList &items)
 
     items.Sort(sorting);
   }
+
+	CLog::Log(LOGDEBUG, "%s finished", "CGUIMediaWindow::SortItems");
 }
 
 // \brief Formats item labels based on the formatting provided by guiViewState
@@ -634,7 +644,8 @@ void CGUIMediaWindow::FormatAndSort(CFileItemList &items)
     viewState->GetSortMethodLabelMasks(labelMasks);
     FormatItemLabels(items, labelMasks);
 
-    items.Sort(viewState->GetSortMethod().sortBy, viewState->GetDisplaySortOrder(), viewState->GetSortMethod().sortAttributes);
+//    if(viewState->GetSortMethod().sortBy != SortBySortTitle)
+    	items.Sort(viewState->GetSortMethod().sortBy, viewState->GetDisplaySortOrder(), viewState->GetSortMethod().sortAttributes);
   }
 }
 
@@ -645,6 +656,9 @@ void CGUIMediaWindow::FormatAndSort(CFileItemList &items)
   */
 bool CGUIMediaWindow::GetDirectory(const CStdString &strDirectory, CFileItemList &items)
 {
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+ 	CLog::Log(LOGDEBUG, "%s started", __FUNCTION__);
+
   // cleanup items
   if (items.Size())
     items.Clear();
@@ -664,6 +678,7 @@ bool CGUIMediaWindow::GetDirectory(const CStdString &strDirectory, CFileItemList
   else
   {
     unsigned int time = XbmcThreads::SystemClockMillis();
+    unsigned int timePart = XbmcThreads::SystemClockMillis();
 
     if (strDirectory.empty())
       SetupShares();
@@ -672,7 +687,7 @@ bool CGUIMediaWindow::GetDirectory(const CStdString &strDirectory, CFileItemList
       return false;
 
     // took over a second, and not normally cached, so cache it
-    if ((XbmcThreads::SystemClockMillis() - time) > 1000  && items.CacheToDiscIfSlow())
+    if ((XbmcThreads::SystemClockMillis() - time) > 1000  && items.CacheToDiscIfSlow() && false)
       items.Save(GetID());
 
     // if these items should replace the current listing, then pop it off the top
@@ -715,6 +730,9 @@ bool CGUIMediaWindow::GetDirectory(const CStdString &strDirectory, CFileItemList
   SetProperty("filter", "");
   m_canFilterAdvanced = false;
   m_filter.Reset();
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", __FUNCTION__, XbmcThreads::SystemClockMillis() - timeFull);
+
   return true;
 }
 
@@ -723,6 +741,14 @@ bool CGUIMediaWindow::GetDirectory(const CStdString &strDirectory, CFileItemList
 // This function calls OnPrepareFileItems() and OnFinalizeFileItems()
 bool CGUIMediaWindow::Update(const CStdString &strDirectory, bool updateFilterPath /* = true */)
 {
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+  unsigned int timePart = XbmcThreads::SystemClockMillis();
+  if (updateFilterPath)
+  	CLog::Log(LOGDEBUG, "%s(%s) started", "CGUIMediaWindow::Update", "true");
+  else
+  	CLog::Log(LOGDEBUG, "%s(%s) started", "CGUIMediaWindow::Update", "false");
+
+
   // TODO: OnInitWindow calls Update() before window path has been set properly.
   if (strDirectory == "?")
     return false;
@@ -751,8 +777,8 @@ bool CGUIMediaWindow::Update(const CStdString &strDirectory, bool updateFilterPa
   if (canfilter && url.HasOption("filter"))
     directory = RemoveParameterFromPath(directory, "filter");
 
-  CFileItemList items;
-  if (!GetDirectory(directory, items))
+  ClearFileItems();
+  if (!GetDirectory(directory, *m_vecItems))
   {
     CLog::Log(LOGERROR,"CGUIMediaWindow::GetDirectory(%s) failed", url.GetRedacted().c_str());
     // Try to return to the previous directory, if not the same
@@ -765,14 +791,14 @@ bool CGUIMediaWindow::Update(const CStdString &strDirectory, bool updateFilterPa
     return false;
   }
 
-  if (items.GetLabel().empty())
-    items.SetLabel(CUtil::GetTitleFromPath(items.GetPath(), true));
+  if (m_vecItems->GetLabel().empty())
+    m_vecItems->SetLabel(CUtil::GetTitleFromPath(m_vecItems->GetPath(), true));
   
-  ClearFileItems();
-  m_vecItems->Copy(items);
-
   // check the given path for filter data
-  UpdateFilterPath(strDirectory, items, updateFilterPath);
+  UpdateFilterPath(strDirectory, *m_vecItems, updateFilterPath);
+
+  CLog::Log(LOGDEBUG, "%s:%s took %d ms ", __FUNCTION__, "part 1", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
     
   // if we're getting the root source listing
   // make sure the path history is clean
@@ -818,6 +844,10 @@ bool CGUIMediaWindow::Update(const CStdString &strDirectory, bool updateFilterPa
   if (m_canFilterAdvanced)
     m_filter.SetType(m_vecItems->GetContent());
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::Update part 2", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+
   //  Ask the derived class if it wants to load additional info
   //  for the fileitems like media info or additional
   //  filtering on the items, setting thumbs.
@@ -834,6 +864,10 @@ bool CGUIMediaWindow::Update(const CStdString &strDirectory, bool updateFilterPa
   // Cache the list of items if possible
   OnCacheFileItems(*m_vecItems);
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::Update part 3", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+
   // Filter and group the items if necessary
   OnFilterItems(GetProperty("filter").asString());
 
@@ -842,6 +876,10 @@ bool CGUIMediaWindow::Update(const CStdString &strDirectory, bool updateFilterPa
   OnFinalizeFileItems(*m_vecItems);
   UpdateButtons();
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::Update part 4", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+
   strSelectedItem = m_history.GetSelectedItem(m_vecItems->GetPath());
 
   bool bSelectedFound = false;
@@ -871,11 +909,20 @@ bool CGUIMediaWindow::Update(const CStdString &strDirectory, bool updateFilterPa
 
   //m_history.DumpPathHistory();
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::Update part 6", XbmcThreads::SystemClockMillis() - timePart);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::Update", XbmcThreads::SystemClockMillis() - timeFull);
+
   return true;
 }
 
 bool CGUIMediaWindow::Refresh(bool clearCache /* = false */)
 {
+  unsigned int time = XbmcThreads::SystemClockMillis();
+  if (clearCache)
+  	CLog::Log(LOGDEBUG, "%s(%s) started", "CGUIMediaWindow::Refresh", "true");
+  else
+  	CLog::Log(LOGDEBUG, "%s(%s) started", "CGUIMediaWindow::Refresh", "false");
+
   CStdString strCurrentDirectory = m_vecItems->GetPath();
   if (strCurrentDirectory.Equals("?"))
     return false;
@@ -884,8 +931,12 @@ bool CGUIMediaWindow::Refresh(bool clearCache /* = false */)
     m_vecItems->RemoveDiscCache(GetID());
 
   // get the original number of items
-  if (!Update(strCurrentDirectory, false))
+  if (!Update(strCurrentDirectory, false)) {
+    CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::Refresh:false", XbmcThreads::SystemClockMillis() - time);
     return false;
+  }
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::Refresh:true", XbmcThreads::SystemClockMillis() - time);
 
   return true;
 }
@@ -896,7 +947,7 @@ bool CGUIMediaWindow::Refresh(bool clearCache /* = false */)
 // It's used to load tag info for music.
 void CGUIMediaWindow::OnPrepareFileItems(CFileItemList &items)
 {
-  CFileItemListModification::Get().Modify(items);
+	CFileItemListModification::Get().Modify(items);
 }
 
 // \brief This function will be called by Update() before
@@ -904,7 +955,7 @@ void CGUIMediaWindow::OnPrepareFileItems(CFileItemList &items)
 // Override this function to define a custom caching behaviour.
 void CGUIMediaWindow::OnCacheFileItems(CFileItemList &items)
 {
-  // Should these items be saved to the hdd
+	// Should these items be saved to the hdd
   if (items.CacheToDiscAlways() && !IsFiltered())
     items.Save(GetID());
 }
@@ -1394,7 +1445,9 @@ bool CGUIMediaWindow::OnPlayAndQueueMedia(const CFileItemPtr &item)
 // on the fileitems of the window
 void CGUIMediaWindow::UpdateFileList()
 {
-  int nItem = m_viewControl.GetSelectedItem();
+	CLog::Log(LOGDEBUG, "%s started", "CGUIMediaWindow::UpdateFileList");
+
+	int nItem = m_viewControl.GetSelectedItem();
   CStdString strSelected;
   if (nItem >= 0)
     strSelected = m_vecItems->Get(nItem)->GetPath();
@@ -1431,6 +1484,8 @@ void CGUIMediaWindow::UpdateFileList()
         g_playlistPlayer.SetCurrentSong(g_playlistPlayer.GetPlaylist(iPlaylist).size() - 1);
     }
   }
+
+  CLog::Log(LOGDEBUG, "%s finished", "CGUIMediaWindow::UpdateFileList");
 }
 
 void CGUIMediaWindow::OnDeleteItem(int iItem)
@@ -1467,7 +1522,11 @@ void CGUIMediaWindow::OnRenameItem(int iItem)
 
 void CGUIMediaWindow::OnInitWindow()
 {
-  // initial fetch is done unthreaded to ensure the items are setup prior to skin animations kicking off
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+  unsigned int timePart = XbmcThreads::SystemClockMillis();
+  CLog::Log(LOGDEBUG, "%s started", "CGUIMediaWindow::OnInitWindow");
+
+	// initial fetch is done unthreaded to ensure the items are setup prior to skin animations kicking off
   m_rootDir.SetAllowThreads(false);
 
   // the start directory may change during Refresh
@@ -1478,10 +1537,16 @@ void CGUIMediaWindow::OnInitWindow()
 
   m_rootDir.SetAllowThreads(true);
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnInitWindow Part 1", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
   if (m_iSelectedItem > -1)
     m_viewControl.SetSelectedItem(m_iSelectedItem);
 
   CGUIWindow::OnInitWindow();
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnInitWindow Part 2", XbmcThreads::SystemClockMillis() - timePart);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnInitWindow", XbmcThreads::SystemClockMillis() - timeFull);
 }
 
 CGUIControl *CGUIMediaWindow::GetFirstFocusableControl(int id)
@@ -1710,7 +1775,12 @@ void CGUIMediaWindow::UpdateFilterPath(const CStdString &strDirectory, const CFi
 
 void CGUIMediaWindow::OnFilterItems(const CStdString &filter)
 {
-  CFileItemPtr currentItem;
+  unsigned int timeFull = XbmcThreads::SystemClockMillis();
+  unsigned int timePart = XbmcThreads::SystemClockMillis();
+ 	CLog::Log(LOGDEBUG, "%s(%s) started", __FUNCTION__, (filter ? filter.c_str() : "NULL"));
+
+
+ 	CFileItemPtr currentItem;
   CStdString currentItemPath;
   int item = m_viewControl.GetSelectedItem();
   if (item >= 0 && item < m_vecItems->Size())
@@ -1719,13 +1789,29 @@ void CGUIMediaWindow::OnFilterItems(const CStdString &filter)
     currentItemPath = currentItem->GetPath();
   }
   
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 1a", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
   m_viewControl.Clear();
   
   CFileItemList items;
   items.Copy(*m_vecItems, false); // use the original path - it'll likely be relied on for other things later.
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 1b", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
   items.Append(*m_unfilteredItems);
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 1c", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
   bool filtered = GetFilteredItems(filter, items);
 
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 1d", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+
   m_vecItems->ClearItems();
   // we need to clear the sort state and re-sort the items
   m_vecItems->ClearSortState();
@@ -1744,50 +1830,100 @@ void CGUIMediaWindow::OnFilterItems(const CStdString &filter)
       m_strFilterPath = items.GetPath();
   }
   
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 2", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+
   GetGroupedItems(*m_vecItems);
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 3.1", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
   FormatAndSort(*m_vecItems);
 
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 3.2", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+
   // get the "filter" option
   CStdString filterOption;
   CURL filterUrl(m_strFilterPath);
   if (filterUrl.HasOption("filter"))
     filterOption = filterUrl.GetOption("filter");
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 4.1", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+  unsigned int timeFill = 0;
+  unsigned int timeSumGetByIndex = 0;
+  unsigned int timeSumItemURL = 0;
+  unsigned int timeSumSetOption = 0;
+  unsigned int timeSumSetPath = 0;
+
   // apply the "filter" option to any folder item so that
   // the filter can be passed down to the sub-directory
-  for (int index = 0; index < m_vecItems->Size(); index++)
-  {
-    CFileItemPtr pItem = m_vecItems->Get(index);
-    // if the item is a folder we need to copy the path of
-    // the filtered item to be able to keep the applied filters
-    if (pItem->m_bIsFolder)
-    {
-      CURL itemUrl(pItem->GetPath());
-      if (!filterOption.empty())
-        itemUrl.SetOption("filter", filterOption);
-      else
-        itemUrl.RemoveOption("filter");
-      pItem->SetPath(itemUrl.Get());
-    }
-  }
+//  for (int index = 0; index < m_vecItems->Size(); index++)
+//  {
+//  	timeFill = XbmcThreads::SystemClockMillis();
+//
+//    CFileItemPtr pItem = m_vecItems->Get(index);
+//
+//    timeSumGetByIndex += (XbmcThreads::SystemClockMillis() - timeFill);
+//    timeFill = XbmcThreads::SystemClockMillis();
+//
+//    // if the item is a folder we need to copy the path of
+//    // the filtered item to be able to keep the applied filters
+//    if (pItem->m_bIsFolder)
+//    {
+//      CURL itemUrl(pItem->GetPath());
+//
+//      timeSumItemURL += (XbmcThreads::SystemClockMillis() - timeFill);
+//      timeFill = XbmcThreads::SystemClockMillis();
+//
+//      if (!filterOption.empty())
+//        itemUrl.SetOption("filter", filterOption);
+//      else
+//        itemUrl.RemoveOption("filter");
+//
+//      timeSumSetOption += (XbmcThreads::SystemClockMillis() - timeFill);
+//      timeFill = XbmcThreads::SystemClockMillis();
+//
+//      pItem->SetPath(itemUrl.Get());
+//
+//      timeSumSetPath += (XbmcThreads::SystemClockMillis() - timeFill);
+//    }
+//  }
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 4.2 - GetByIndex", timeSumGetByIndex);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 4.2 - ItemURL", timeSumItemURL);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 4.2 - SetOption", timeSumSetOption);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 4.2 - SetPath", timeSumSetPath);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 4.2", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
 
   SetProperty("filter", filter);
-  if (filtered && m_canFilterAdvanced)
-  {
-    // to be able to select the same item as before we need to adjust
-    // the path of the item i.e. add or remove the "filter=" URL option
-    // but that's only necessary for folder items
-    if (currentItem.get() != NULL && currentItem->m_bIsFolder)
-    {
-      CURL curUrl(currentItemPath), newUrl(m_strFilterPath);
-      if (newUrl.HasOption("filter"))
-        curUrl.SetOption("filter", newUrl.GetOption("filter"));
-      else if (curUrl.HasOption("filter"))
-        curUrl.RemoveOption("filter");
+//  if (filtered && m_canFilterAdvanced)
+//  {
+//    // to be able to select the same item as before we need to adjust
+//    // the path of the item i.e. add or remove the "filter=" URL option
+//    // but that's only necessary for folder items
+//    if (currentItem.get() != NULL && currentItem->m_bIsFolder)
+//    {
+//      CURL curUrl(currentItemPath), newUrl(m_strFilterPath);
+//      if (newUrl.HasOption("filter"))
+//        curUrl.SetOption("filter", newUrl.GetOption("filter"));
+//      else if (curUrl.HasOption("filter"))
+//        curUrl.RemoveOption("filter");
+//
+//      currentItemPath = curUrl.Get();
+//    }
+//  }
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 5", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
 
-      currentItemPath = curUrl.Get();
-    }
-  }
 
   // The idea here is to ensure we have something to focus if our file list
   // is empty.  As such, this check MUST be last and ignore the hide parent
@@ -1801,10 +1937,17 @@ void CGUIMediaWindow::OnFilterItems(const CStdString &filter)
     m_vecItems->AddFront(pItem, 0);
   }
 
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 6", XbmcThreads::SystemClockMillis() - timePart);
+  timePart = XbmcThreads::SystemClockMillis();
+
+
   // and update our view control + buttons
   m_viewControl.SetItems(*m_vecItems);
   m_viewControl.SetSelectedItem(currentItemPath);
   UpdateButtons();
+
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems part 7", XbmcThreads::SystemClockMillis() - timePart);
+  CLog::Log(LOGDEBUG, "%s took %d ms ", "CGUIMediaWindow::OnFilterItems", XbmcThreads::SystemClockMillis() - timeFull);
 }
 
 bool CGUIMediaWindow::GetFilteredItems(const CStdString &filter, CFileItemList &items)
diff --git a/xbmc/windows/GUIMediaWindow.h b/xbmc/windows/GUIMediaWindow.h
index b4d73ee..a918dc1 100644
--- a/xbmc/windows/GUIMediaWindow.h
+++ b/xbmc/windows/GUIMediaWindow.h
@@ -112,7 +112,7 @@ protected:
    \param filter the filter to use.
    \sa FilterItems
    */
-  void OnFilterItems(const CStdString &filter);
+  virtual void OnFilterItems(const CStdString &filter);
 
   /* \brief Retrieve the filtered item list
    \param filter filter to apply
@@ -133,7 +133,7 @@ protected:
   virtual bool HaveDiscOrConnection(const CStdString& strPath, int iDriveType);
   void ShowShareErrorMessage(CFileItem* pItem);
 
-  void GetDirectoryHistoryString(const CFileItem* pItem, CStdString& strHistoryString);
+  virtual void GetDirectoryHistoryString(const CFileItem* pItem, CStdString& strHistoryString);
   void SetHistoryForPath(const CStdString& strDirectory);
   virtual void LoadPlayList(const CStdString& strFileName) {}
   virtual bool OnPlayMedia(int iItem);
